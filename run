#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: $0 <path_to_test_directory>"
    exit 1
fi
dir_to_test="$1"

csv_file="bench.csv"
txt_file="bench.txt"
pwd=$(pwd)

cd "$dir_to_test" || { echo "Error: Directory '$dir_to_test' does not exist."; exit 1; }
go test -bench=. > "$pwd/$txt_file"
cd "$pwd"
echo "Raw output written to $txt_file"

echo "method,ms_per_op" > "$csv_file"
cat bench.txt | awk '/ns\/op/ { 
    gsub(/^Benchmark/, "", $1);    # Remove "Benchmark" from the start
    gsub(/-8$/, "", $1);           # Remove "-8" from the end
    printf "%s,%.3f\n", $1, $3/1000000 
}' >> "$csv_file"
echo "CSV output written to $csv_file"

echo "Running main.py to generate plots"
python main.py
